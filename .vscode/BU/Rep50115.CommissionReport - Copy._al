report 50115 "Commission Report"
{
    ApplicationArea = All;
    Caption = 'Commission Report';
    UsageCategory = ReportsAndAnalysis;
    DefaultLayout = RDLC;
    RDLCLayout = './.vscode/ReportLayout/CommissionReport.rdl';

    dataset
    {
        dataitem(TmpCommission; TmpCommission)
        {
            DataItemTableView = sorting(CustNo, Type, DatePaid, InvoiceNo, ItemNo);

            column(DatePaid; DatePaid)
            {
            }
            column(InvoiceNo; InvoiceNo)
            {

            }
            column(ItemDescription; Description)
            {

            }
            column(CustNo; CustNo)
            {
            }
            column(ExtDocNo; ExtDocNo)
            {
            }
            column(Type; "Type")
            {
            }
            column(CustName; Customer.Name)
            {
            }
            column(ItemNo; ItemNo)
            {
            }
            column(Description; Description)
            {
            }
            column(Qty; Qty)
            {
            }
            column(SalesPrice; SalesPrice)
            {
            }
            column(OriginalAmount; OriginalAmount)
            {
            }
            column(PaidAmount; PaidAmount)
            {
            }
            column(CashPaidAmount; CashPaidAmount)
            {
            }
            column(OrderNo; OrderNo)
            {

            }
            column(bCashPaidNotEq; bCashPaidNotEq)
            {

            }
            column(ItemSort; ItemSort)
            {

            }
            column(UserID; UserID)
            {

            }

            trigger OnAfterGetRecord()
            begin
                If Customer.get(TmpCommission.CustNo) then;

            end;

            trigger OnPreDataItem()
            begin
                TmpCommission.SetRange(Type, 'Invoice');
                TmpCommission.SetRange(UserID, UserID);
            end;

        }
    }
    requestpage
    {
        layout
        {
            area(Content)
            {
                group(Criteria)
                {
                    Caption = 'Report Filter';
                    field(StartDate; StartDate)
                    {
                        ApplicationArea = All;
                        Caption = 'Start Date';
                    }
                    field(EndDate; EndDate)
                    {
                        ApplicationArea = All;
                        Caption = 'End Date';
                    }
                    field(GetCustNo; GetCustNo)
                    {
                        Caption = 'Customer No.';
                        ApplicationArea = All;
                        TableRelation = Customer."No.";
                    }
                }
            }
        }
        actions
        {
            area(Processing)
            {
            }
        }

    }

    var
        test: boolean;
        StartDate: Date;
        EndDate: Date;
        GetSumCommission: Record TmpCommissionSum;
        Customer: Record Customer;
        Item: Record Item;
        lblDiscountAllowance: Label '%1 Invoice Discount/Allowance';
        lblChargeback: Label '**%1 Chargeback**';
        GetCustNo: Code[20];
        ErrNoDataFound: Label 'No data found.  Please check your parameters.';


    trigger OnPreReport()
    var
        ILE: Record "Item Ledger Entry";
        CBGLE: Record "SIMC Cash G/L Entry";
        ChkCBGLE: Record "SIMC Cash G/L Entry";
        GetAmount: Decimal;
        SalesInvHdr: Record "Sales Invoice Header";
        SalesInvLn: Record "Sales Invoice Line";
        InsTmpCommission: Record TmpCommission;
        CLE: Record "Cust. Ledger Entry";
        GetDescrip: Text;
        ChkTmpCommission: Record TmpCommission;
        GetTotal: Decimal;
        SalesCM: Record "Sales Cr.Memo Header";
        SalesCMLine: Record "Sales Cr.Memo Line";
        totalCashPaid: Decimal;
        DetCLE: Record "Detailed Cust. Ledg. Entry";
        SRSetup: Record "Sales & Receivables Setup";
        GetInvTotalB4Disc: Decimal;
    begin

        if SRSetup.Find() then;

        TmpCommission.SetRange(UserID, UserID);
        if TmpCommission.FindSet() then
            TmpCommission.DeleteAll();


        GetSumCommission.SetRange(UserID, UserID);
        If GetSumCommission.FindSet() then
            GetSumCommission.DeleteAll();



        CBGLE.Reset();
        CBGLE.SetRange("Posting Date", StartDate, EndDate);
        CBGLE.SetRange("Document Type", CBGLE."Document Type"::"Sales Invoice");
        CBGLE.SetRange("Source Type", CBGLE."Source Type"::Customer);
        // CBGLE.SetRange("Document No.", 'PS-INV106215');  //mbr test - for testing purposes only
        CBGLE.SetFilter("Document Posting Date", '>=%1', SRSetup.InvoiceEarliestDate);
        if StrLen(GetCustNo) > 0 then
            CBGLE.SetRange("Source No.", GetCustNo);
        CBGLE.SetRange("Applied Document Type", CBGLE."Applied Document Type"::Payment);
        IF CBGLE.FindSet() then
            repeat
                GetAmount := 0;
                ChkCBGLE.Reset();
                ChkCBGLE.SetRange("Document Type", CBGLE."Document Type");
                ChkCBGLE.SetRange("Source No.", CBGLE."Source No.");
                ChkCBGLE.SetRange("Document No.", CBGLE."Document No.");
                ChkCBGLE.SetRange("Posting Date", StartDate, EndDate);
                ChkCBGLE.SetRange("Applied Document Type", ChkCBGLE."Applied Document Type"::Payment);

                if ChkCBGLE.FindSet() then
                    repeat
                        GetAmount := GetAmount + Abs(ChkCBGLE.Amount);
                    until ChkCBGLE.Next() = 0;

                GetSumCommission.Reset();
                GetSumCommission.SetRange(Type, 'InvoiceTotal');
                GetSumCommission.SetRange(InvoiceNo, CBGLE."Document No.");
                GetSumCommission.SetRange(CustNo, CBGLE."Source No.");
                GetSumCommission.SetRange(UserID, UserId);

                If NOT GetSumCommission.FindFirst() then begin
                    GetSumCommission.Init();
                    GetSumCommission.CustNo := CBGLE."Source No.";
                    GetSumCommission.Type := 'InvoiceTotal';
                    GetSumCommission.CashPaidAmount := GetAmount;
                    GetSumCommission.InvoiceNo := CBGLE."Document No.";
                    GetSumCommission.DatePaid := CBGLE."Posting Date";
                    GetSumCommission.UserID := UserId;
                    GetSumCommission.Insert;
                end;
            until CBGLE.Next() = 0
        else
            Error(ErrNoDataFound);

        //update the corresponding Sales Order No
        GetSumCommission.reset;
        GetSumCommission.SetRange(UserID, UserId);
        IF GetSumCommission.FindSet() then
            repeat
                SalesInvHdr.Reset();
                SalesInvHdr.SetRange("No.", GetSumCommission.InvoiceNo);
                If SalesInvHdr.FindFirst() then begin
                    GetSumCommission.OrderNo := SalesInvHdr."Order No.";
                    IF SalesInvHdr."Invoice Discount Value" > 0 then begin
                        GetSumCommission.InvDiscExists := true;
                        InsTmpCommission.Init();
                        InsTmpCommission.CustNo := GetSumCommission.CustNo;
                        InsTmpCommission.CashPaidAmount := GetSumCommission.CashPaidAmount;
                        InsTmpCommission.InvoiceNo := GetSumCommission.InvoiceNo;
                        InsTmpCommission.DatePaid := GetSumCommission.DatePaid;
                        InsTmpCommission.UserID := GetSumCommission.UserID;
                        InsTmpCommission.OrderNo := GetSumCommission.OrderNo;
                        InsTmpCommission.InvDiscExists := GetSumCommission.InvDiscExists;
                        InsTmpCommission.Type := 'Invoice';
                        InsTmpCommission.Description := StrSubstNo(lblDiscountAllowance, SalesInvHdr."Sell-to Customer Name");
                        InsTmpCommission.SalesPrice := SalesInvHdr."Invoice Discount Value" * -1;
                        InsTmpCommission.OriginalAmount := InsTmpCommission.SalesPrice;
                        InsTmpCommission.PaidAmount := InsTmpCommission.SalesPrice;
                        InsTmpCommission.ItemNo := 'DISC';
                        InsTmpCommission.ItemSort := 1;
                        InsTmpCommission.Qty := 0;
                        InsTmpCommission.UserID := UserId;
                        InsTmpCommission.Insert();
                    end;
                    GetSumCommission.Modify();
                end;
            until GetSumCommission.Next() = 0;



        GetSumCommission.reset;
        GetSumCommission.SetRange(UserID, UserId);
        GetSumCommission.SetRange(Type, 'InvoiceTotal');
        IF GetSumCommission.FindSet() then
            repeat
                if STRLEN(GetSumCommission.OrderNo) > 0 then begin
                    ILE.Reset();
                    ILE.SetRange("Entry Type", ILE."Entry Type"::Sale);
                    ILE.SetRange("Source Type", ILE."Source Type"::Customer);
                    ILE.SetRange("Sales Shipment Source No.", GetSumCommission.OrderNo);
                    ILE.SetRange("Source No.", GetSumCommission.CustNo);

                    IF ILE.FindSet() then
                        repeat
                            ILE.CalcFields("Sales Amount (Actual)", "Sales Shipment Source No.");
                            TmpCommission.Reset();
                            TmpCommission.SetRange(UserID, UserId);
                            TmpCommission.SetRange(Type, 'Invoice');
                            TmpCommission.SetRange(CustNo, ILE."Source No.");
                            TmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);

                            TmpCommission.SetRange(ItemNo, ILE."Item No.");
                            TmpCommission.SetRange(UserID, UserId);

                            If TmpCommission.FindFirst() then begin
                                TmpCommission.Qty := TmpCommission.Qty + Abs(ILE."Invoiced Quantity");
                                TmpCommission.OriginalAmount := TmpCommission.OriginalAmount + ILE."Sales Amount (Actual)";
                                TmpCommission.PaidAmount := TmpCommission.PaidAmount + ILE."Sales Amount (Actual)";
                                TmpCommission.Modify(true);
                            end
                            else begin
                                TmpCommission.Init();
                                TmpCommission.Type := 'Invoice';
                                TmpCommission.CustNo := ILE."Source No.";
                                TmpCommission.ExtDocNo := ILE."External Document No.";
                                TmpCommission.InvoiceNo := GetSumCommission.InvoiceNo;
                                TmpCommission.OrderNo := GetSumCommission.OrderNo;
                                TmpCommission.InvDiscExists := GetSumCommission.InvDiscExists;
                                TmpCommission.ItemNo := ILE."Item No.";
                                If Item.get(TmpCommission.ItemNo) then
                                    TmpCommission.Description := Item.Description;
                                TmpCommission.Qty := Abs(ILE."Invoiced Quantity");
                                TmpCommission.UserID := UserId;
                                TmpCommission.PaidAmount := ILE."Sales Amount (Actual)";
                                TmpCommission.DatePaid := GetSumCommission.DatePaid;
                                TmpCommission.OrderNo := ILE."Sales Shipment Source No.";
                                TmpCommission.InvDiscExists := GetSumCommission.InvDiscExists;
                                TmpCommission.ItemSort := 0;
                                TmpCommission.Insert();
                            end;


                        until ILE.Next() = 0;
                end;

            until GetSumCommission.Next() = 0;



        //update the originalamount by going to each Posted Sales Line
        TmpCommission.Reset();
        TmpCommission.SetRange(UserID, UserId);
        TmpCommission.SetRange(Type, 'Invoice');
        If TmpCommission.FindSet() then
            repeat
                SalesInvLn.Reset();
                SalesInvLn.SetRange("Document No.", TmpCommission.InvoiceNo);
                SalesInvLn.SetRange(Type, SalesInvLn.Type::Item);
                SalesInvLn.SetRange("No.", TmpCommission.ItemNo);
                If SalesInvLn.FindFirst() then begin
                    TmpCommission.OriginalAmount := SalesInvLn."Line Amount";
                    If TmpCommission.Qty > 0 then
                        TmpCommission.SalesPrice := TmpCommission.OriginalAmount / TmpCommission.Qty;

                    If TmpCommission.InvDiscExists = true then
                        TmpCommission.PaidAmount := TmpCommission.OriginalAmount;
                    TmpCommission.Modify();
                end;
            until TmpCommission.Next() = 0;

        //Let's make sure paid amount is adjusted with what was actually applied in terms of payment
        //If not equal then use below formula:
        //Formula: Paid Amount = ([Cash (or Payment) Received Amount]/[Total Invoice Amount]) * ([Item Line Amount] 


        GetSumCommission.Reset();
        GetSumCommission.SetRange(UserID, UserId);
        GetSumCommission.SetRange(Type, 'InvoiceTotal');
        If GetSumCommission.FindSet() then
            repeat
                GetAmount := 0;
                GetTotal := 0;
                totalCashPaid := 0;
                GetInvTotalB4Disc := 0;

                //Calculate Inv Total before any discounts are taken (except pmt disc)
                ChkTmpCommission.Reset();
                ChkTmpCommission.SetRange(UserID, UserId);
                ChkTmpCommission.SetRange(Type, 'Invoice');
                ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                ChkTmpCommission.SetRange(CustNo, GetSumCommission.CustNo);
                ChkTmpCommission.SetFilter(ItemNo, '<>%1&<>%2', 'DISC', 'PMTDISC');
                if ChkTmpCommission.FindSet() then
                    repeat
                        GetInvTotalB4Disc := GetInvTotalB4Disc + ChkTmpCommission.OriginalAmount;
                    until ChkTmpCommission.Next() = 0;

                totalCashPaid := Round(GetSumCommission.CashPaidAmount, 0.01);


                ChkTmpCommission.Reset();
                ChkTmpCommission.SetRange(UserID, UserId);
                ChkTmpCommission.SetRange(Type, 'Invoice');
                ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                ChkTmpCommission.SetRange(CustNo, GetSumCommission.CustNo);
                ChkTmpCommission.SetFilter(ItemNo, '<>%1&<>%2', 'DISC', 'PMTDISC');
                if ChkTmpCommission.FindSet() then
                    repeat
                        GetAmount := GetAmount + abs(Round(ChkTmpCommission.PaidAmount, 0.01));   //mbr DO NOT INCLUDE DISCOUNT or PMTDISC
                    until ChkTmpCommission.Next() = 0;
                if GetAmount <> totalCashPaid then begin

                    SalesInvHdr.Reset();
                    SalesInvHdr.SetRange("No.", GetSumCommission.InvoiceNo);
                    SalesInvHdr.SetRange("Sell-to Customer No.", GetSumCommission.CustNo);
                    If SalesInvHdr.findfirst then begin
                        SalesInvHdr.CalcFields(Amount);
                        //Let's update the paid amount to actdual payment applied 
                        ChkTmpCommission.Reset();
                        ChkTmpCommission.SetRange(UserID, UserId);
                        ChkTmpCommission.SetRange(Type, 'Invoice');
                        ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                        ChkTmpCommission.SetRange(CustNo, GetSumCommission.CustNo);
                        ChkTmpCommission.SetFilter(ItemNo, '<>%1&<>%2', 'DISC', 'PMTDISC');
                        if ChkTmpCommission.FindSet() then
                            repeat
                                //Formula: Paid Amount = ([Cash (or Payment) Received Amount]/[Total Invoice Amount]) * ([Item Line Amount] 
                                ChkTmpCommission.PaidAmount := (totalCashPaid / GetInvTotalB4Disc) * ChkTmpCommission.OriginalAmount;
                                ChkTmpCommission.Modify();
                            until ChkTmpCommission.Next() = 0;
                    end;
                end;
            until GetSumCommission.Next() = 0;



        GetSumCommission.Reset();
        GetSumCommission.SetRange(UserID, UserId);
        GetSumCommission.SetRange(Type, 'InvoiceTotal');
        IF GetSumCommission.FindSet() then
            repeat
                CBGLE.Reset();
                CBGLE.SetRange("Document Type", CBGLE."Document Type"::"Sales Invoice");
                CBGLE.SetRange("Source Type", CBGLE."Source Type"::Customer);
                CBGLE.SetRange("Source No.", GetSumCommission.CustNo);
                CBGLE.SetRange("Applied Document Type", CBGLE."Applied Document Type"::"Sales Cr. Memo");
                CBGLE.SetRange("Document No.", GetSumCommission.InvoiceNo);
                CBGLE.SetRange("Posting Date", StartDate, EndDate);
                CBGLE.SetFilter("Document Posting Date", '>=%1', SRSetup.InvoiceEarliestDate);

                GetAmount := 0;
                GetDescrip := '';
                IF CBGLE.FindSet() then
                    repeat
                        GetAmount := GetAmount + CBGLE."Credit Amount";
                        SalesCM.Reset();
                        SalesCM.SetRange("No.", CBGLE."Applied Document No.");
                        IF SalesCM.FindFirst() then begin
                            SalesCMLine.Reset();
                            SalesCMLine.SetRange("Document No.", SalesCM."No.");
                            SalesCMLine.SetRange(Type, SalesCMLine.Type::"G/L Account");
                            if SalesCMLine.FindSet() then
                                repeat
                                    GetDescrip := SalesCMLine.Description;
                                until SalesCMLine.Next() = 0;
                        end;
                        if StrLen(GetDescrip) = 0 then begin
                            CLE.Reset();
                            CLE.SetRange("Customer No.", GetSumCommission.CustNo);
                            CLE.SetRange("Document No.", CBGLE."Applied Document No.");
                            IF CLE.FindFirst() then
                                GetDescrip := CLE.Description;
                        end;

                    until CBGLE.Next() = 0;
                if GetAmount > 0 then begin
                    InsTmpCommission.Init();
                    InsTmpCommission.CustNo := GetSumCommission.CustNo;
                    InsTmpCommission.CashPaidAmount := GetSumCommission.CashPaidAmount;
                    InsTmpCommission.InvoiceNo := GetSumCommission.InvoiceNo;
                    InsTmpCommission.DatePaid := GetSumCommission.DatePaid;
                    InsTmpCommission.UserID := GetSumCommission.UserID;
                    InsTmpCommission.OriginalAmount := GetAmount * -1;
                    InsTmpCommission.PaidAmount := GetAmount * -1;
                    InsTmpCommission.Description := GetDescrip;
                    InsTmpCommission.Type := 'Invoice';
                    InsTmpCommission.ItemNo := 'PMTDISC';
                    InsTmpCommission.ItemSort := 2;
                    InsTmpCommission.Insert();
                end;
            until GetSumCommission.Next() = 0;

        //now, let's find out if customers short paid.  If so, deduct from applicable item paid amounts
        /*
        totalCashPaid := 0;
        GetSumCommission.Reset();
        GetSumCommission.SetRange(UserID, UserId);
        GetSumCommission.SetRange(Type, 'InvoiceTotal');
        //   GetSumCommission.SetRange(bCashPaidNotEq, true);  //not needed ...delete after testing
        If GetSumCommission.FindSet() then
            repeat
                GetAmount := 0;
                GetTotal := 0;
                totalCashPaid := Round(GetSumCommission.CashPaidAmount, 0.01);
                ChkTmpCommission.Reset();
                ChkTmpCommission.SetRange(UserID, UserId);
                ChkTmpCommission.SetRange(Type, 'Invoice');
                ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                ChkTmpCommission.SetFilter(ItemNo, '%1|%2', 'DISC', 'PMTDISC');
                ChkTmpCommission.SetFilter(CustNo, GetSumCommission.CustNo);
                if ChkTmpCommission.FindSet() then
                    repeat
                        GetAmount := GetAmount + abs(Round(ChkTmpCommission.PaidAmount, 0.01));
                    until ChkTmpCommission.Next() = 0;

                ChkTmpCommission.Reset();
                ChkTmpCommission.SetRange(UserID, UserId);
                ChkTmpCommission.SetRange(Type, 'Invoice');
                ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                ChkTmpCommission.SetFilter(ItemNo, '<>%1&<>%2', 'DISC', 'PMTDISC');
                if ChkTmpCommission.FindSet() then
                    repeat
                        GetTotal := GetTotal + Round(ChkTmpCommission.PaidAmount, 0.01);
                    until ChkTmpCommission.Next() = 0;
                IF (totalCashPaid <> GetTotal) then
                    if ((totalCashPaid - GetAmount) < GetTotal) then begin
                        //this means there are remaining amount in the CLE.  Let's subtract from Paid amount;
                        CLE.Reset();
                        CLE.SetRange("Customer No.", GetSumCommission.CustNo);
                        CLE.SetRange("Document Type", CLE."Document Type"::Invoice);
                        CLE.SetRange("Document No.", GetSumCommission.InvoiceNo);
                        IF CLE.FindFirst() then begin
                            GetAmount := 0;
                            CLE.CalcFields("Remaining Amount");
                            IF CLE."Remaining Amount" > 0 then begin
                                GetAmount := CLE."Remaining Amount";
                                InsTmpCommission.Reset();
                                InsTmpCommission.SetCurrentKey(UserID, CustNo, InvoiceNo, PaidAmount);
                                InsTmpCommission.SetRange(UserID, UserId);
                                InsTmpCommission.SetRange(Type, 'Invoice');
                                InsTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                                InsTmpCommission.Ascending(false);
                                If InsTmpCommission.FindSet() then
                                    repeat
                                        if Item.Get(InsTmpCommission.ItemNo) then begin

                                            IF Round(InsTmpCommission.PaidAmount, 0.01) >= GetAmount then begin
                                                TmpCommission.Reset();
                                                TmpCommission.SetRange(UserID, UserId);
                                                TmpCommission.SetRange(Type, 'Invoice');
                                                TmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                                                TmpCommission.SetRange(ItemNo, InsTmpCommission.ItemNo);
                                                If TmpCommission.FindFirst() then begin

                                                    TmpCommission.PaidAmount := TmpCommission.PaidAmount - GetAmount;
                                                    GetAmount := 0;
                                                    TmpCommission.Modify(false);
                                                end;

                                            end
                                            else begin

                                                TmpCommission.Reset();
                                                TmpCommission.SetRange(UserID, UserId);
                                                TmpCommission.SetRange(Type, 'Invoice');
                                                TmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                                                TmpCommission.SetRange(ItemNo, InsTmpCommission.ItemNo);
                                                If TmpCommission.FindFirst() then begin
                                                    GetAmount := GetAmount - Round(InsTmpCommission.PaidAmount, 0.01);
                                                    TmpCommission.PaidAmount := 0;
                                                    TmpCommission.Modify(false);
                                                end;

                                            end;


                                        end;

                                    until (InsTmpCommission.Next() = 0) or (GetAmount <= 0);
                            end;
                        end;
                    end;
            until GetSumCommission.Next() = 0;
*/

        /*
                //Check Total Paid amount from Cash Basis vs total amount in Invoice Paid Amount
                GetSumCommission.Reset();
                GetSumCommission.SetRange(UserID, UserId);
                GetSumCommission.SetRange(Type, 'InvoiceTotal');
                If GetSumCommission.FindSet() then
                    repeat

                        totalCashPaid := 0;
                        GetTotal := 0;
                        totalCashPaid := Round(GetSumCommission.CashPaidAmount, 0.01);
                        ChkTmpCommission.Reset();
                        ChkTmpCommission.SetRange(UserID, UserId);
                        ChkTmpCommission.SetRange(Type, 'Invoice');
                        ChkTmpCommission.SetRange(InvoiceNo, GetSumCommission.InvoiceNo);
                        if ChkTmpCommission.FindSet() then
                            repeat
                                GetTotal := GetTotal + Round(ChkTmpCommission.PaidAmount, 0.01);
                            until ChkTmpCommission.Next() = 0;

                        if GetTotal > totalCashPaid then begin
                            GetTotal := GetTotal - totalCashPaid;
                            If GetTotal > 0 then begin
                                CLE.Reset();
                                CLE.SetRange("Customer No.", ChkTmpCommission.CustNo);
                                CLE.SetRange("Document No.", ChkTmpCommission.InvoiceNo);
                                CLE.SetRange("Document Type", CLE."Document Type"::Invoice);
                                IF CLE.FindFirst() then begin
                                    DetCLE.Reset();
                                    DetCLE.SetRange("Document Type", DetCLE."Document Type"::Payment);
                                    DetCLE.SetRange("Cust. Ledger Entry No.", CLE."Entry No.");
                                    DetCLE.SetFilter("Posting Date", '<%1', StartDate);
                                    If DetCLE.FindSet() then
                                        repeat
                                            InsTmpCommission.Reset();
                                            InsTmpCommission.SetCurrentKey(UserID, CustNo, InvoiceNo, PaidAmount);
                                            InsTmpCommission.SetRange(UserID, UserId);
                                            InsTmpCommission.SetRange(Type, 'Invoice');
                                            InsTmpCommission.SetRange(InvoiceNo, CLE."Document No.");
                                            InsTmpCommission.Ascending(false);
                                            If InsTmpCommission.FindSet() then
                                                repeat
                                                    if Item.Get(InsTmpCommission.ItemNo) then begin

                                                        IF Round(InsTmpCommission.PaidAmount, 0.01) >= GetTotal then begin
                                                            TmpCommission.Reset();
                                                            TmpCommission.SetRange(UserID, UserId);
                                                            TmpCommission.SetRange(Type, 'Invoice');
                                                            TmpCommission.SetRange(InvoiceNo, InsTmpCommission.InvoiceNo);
                                                            TmpCommission.SetRange(ItemNo, InsTmpCommission.ItemNo);
                                                            If TmpCommission.FindFirst() then begin
                                                                TmpCommission.PaidAmount := TmpCommission.PaidAmount - GetTotal;
                                                                GetTotal := 0;
                                                                TmpCommission.Modify(false);
                                                            end;

                                                        end
                                                        else begin

                                                            TmpCommission.Reset();
                                                            TmpCommission.SetRange(UserID, UserId);
                                                            TmpCommission.SetRange(Type, 'Invoice');
                                                            TmpCommission.SetRange(InvoiceNo, InsTmpCommission.InvoiceNo);
                                                            TmpCommission.SetRange(ItemNo, InsTmpCommission.ItemNo);
                                                            If TmpCommission.FindFirst() then begin
                                                                GetTotal := GetTotal - Round(InsTmpCommission.PaidAmount, 0.01);
                                                                TmpCommission.PaidAmount := 0;
                                                                TmpCommission.Modify(false);
                                                            end;

                                                        end;


                                                    end;

                                                until (InsTmpCommission.Next() = 0) or (GetTotal <= 0);
                                        until (DetCLE.Next() = 0) or (GetTotal <= 0);
                                end;

                            end;

                        end;
                    until GetSumCommission.Next() = 0;
        */
        //update External Doc No if need be
        TmpCommission.Reset();
        TmpCommission.SetRange(UserID, UserId);
        TmpCommission.SetRange(Type, 'Invoice');
        TmpCommission.SetFilter(ExtDocNo, '=%1', '');
        TmpCommission.SetFilter(InvoiceNo, '<>%1', '');
        IF TmpCommission.FindSet() then
            repeat
                SalesInvHdr.Reset();
                SalesInvHdr.SetRange("No.", TmpCommission.InvoiceNo);
                If SalesInvHdr.FindFirst() then begin
                    TmpCommission.ExtDocNo := SalesInvHdr."External Document No.";
                    TmpCommission.Modify();
                end;
            until TmpCommission.Next() = 0;

    end;
}
